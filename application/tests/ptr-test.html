<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <script src="https://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
    <script src="../config.js"></script>
    <script type="text/javascript">
      var tests = ['Success (201)', 'Malformed Json (400)', 'PTR Missing Key (401)', 'PTR Missing Value (402)'];
      // TODO
      // , 'Boomerang', 'Completed' others?

      var runTests = function() {
        jQuery("#response-container").text("");

        jQuery.each(tests, function(v, k) {
          var obj = null;
          switch (v) {
            // TEST 1 - no changes to json
            case 0:
              obj = JSON.stringify(JSON.parse(sampleJson));
              break;

            // TEST 2 - malformed json
            case 1:
              obj = '{"a":"b","c":"d,}';
              break;

            // TEST 3 - misname a key in the json
            case 2:
              var json = JSON.parse(sampleJson);
              json = JSON.parse(JSON.stringify(json).split('"request_id":').join('"misnamed_key":'));
              obj = JSON.stringify(json);
              break;

            // TEST 3 - remove a value from the json
            case 3:
              var json = JSON.parse(sampleJson);
              json.request_id = "";
              obj = JSON.stringify(json);
              break;
          }

          jQuery.ajax(config.ptr_url, {
            type: 'POST',
            data: obj,
            contentType: 'application/json',
            dataType: 'json',
            success: function(e) {
              jQuery("#response-container").append('<div style="color: #3e9600;">' + k + ' test PASSED </div><br />');
            },
            error: function(e) {
              if (e.status == 400 || e.status == 401 || e.status == 402) {
                jQuery("#response-container").append('<div style="color: #3e9600;">' + k + ' test PASSED with expected error returned >> ' + e.statusText+ '</div><br />');
              } else {
                jQuery("#response-container").append('<div  style="color: #f21713;">' + k + ' test FAILED with unexpected error returned >> ' + e.statusText+ '</div><br />');
              }
            }
          });
        });
      }

      jQuery(document).ready(function() {
        jQuery('#submit').click(function() {
          runTests();
        });
      });
    </script>
  </head>

  <body>
    <h3>Testing for the CIRA PTR API</h3>
    <button id="submit">Begin test</button>
    <br />
    <br />
    <br />
    <div id="response-container" style="margin-left: 30px;"></div>
  </body>
</html>

<script type="text/javascript">
  var sampleJson = `{
    "request_id": 541084,
    "ipt_timestamp": "2017-06-05 22:42:17",
    "ipt_client_ip": "156.57.201.139",
    "ipt_client_postal_code": "A2A2L1",
    "ipt_client_asn": 855,
    "submitter": "CIRA IPT",
    "ipt_server_ip": "162.219.49.25",
    "ipt_server_city": "Montreal",
    "ipt_server_postal_code": "null",
    "os": "Windows",
    "protocol": "ICMP",
    "hops": [
      {
        "num": 1,
        "ip": "162.219.49.1",
        "rtts": [
          "0.285",
          "7.480",
          "30.185"
        ]
      },
      {
        "num": 2,
        "ip": "184.105.64.89",
        "rtts": [
          "12.081",
          "12.188",
          "12.262"
        ]
      },
      {
        "num": 3,
        "ip": "198.32.118.165",
        "rtts": [
          "12.574",
          "13.389",
          "14.972"
        ]
      },
      {
        "num": 4,
        "ip": "207.231.227.117",
        "rtts": [
          "21.943",
          "22.025",
          "22.131"
        ]
      },
      {
        "num": 5,
        "ip": "207.231.227.54",
        "rtts": [
          "39.690",
          "39.819",
          "39.971"
        ]
      },
      {
        "num": 6,
        "ip": "142.166.129.66",
        "rtts": [
          "42.801",
          "42.955",
          "43.143"
        ]
      },
      {
        "num": 7,
        "ip": "142.166.218.65",
        "rtts": [
          "43.183",
          "43.770",
          "45.003"
        ]
      },
      {
        "num": 8,
        "ip": "142.166.211.73",
        "rtts": [
          "43.469",
          "44.022",
          "44.964"
        ]
      },
      {
        "num": 9,
        "ip": "142.166.149.94",
        "rtts": [
          "42.832",
          "42.969",
          "43.149"
        ]
      },
      {
        "num": 10,
        "ip": "142.166.181.114",
        "rtts": [
          "52.534",
          "52.787",
          "53.167"
        ]
      },
      {
        "num": 11,
        "ip": "142.176.50.126",
        "rtts": [
          "52.613",
          "52.721",
          "52.856"
        ]
      },
      {
        "num": 12,
        "ip": null,
        "rtts": [
          "-1",
          "-1",
          "-1"
        ],
        "err": "timeout"
      },
      {
        "num": 13,
        "ip": null,
        "rtts": [
          "-1",
          "-1",
          "-1"
        ],
        "err": "timeout"
      },
      {
        "num": 14,
        "ip": null,
        "rtts": [
          "-1",
          "-1",
          "-1"
        ],
        "err": "timeout"
      }
    ]
  }`
</script>